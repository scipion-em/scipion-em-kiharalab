name: Build plugin on Pull Request
on:
  pull_request:
    branches: [devel, master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Free Disk Space (Ubuntu only)
      uses: jlumbroso/free-disk-space@main

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gcc-10 g++-10 libopenmpi-dev make
        
    - name: Install Miniconda
      working-directory: ${{ github.workspace }}/../
      run: |
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
        bash Miniconda3-latest-Linux-x86_64.sh -b -p miniconda/
        source miniconda/etc/profile.d/conda.sh
        conda update -n base -c defaults conda -y
    
    - name: Install Scipion
      working-directory: ${{ github.workspace }}/../
      run: |
        eval "$(miniconda/bin/conda shell.bash hook)"
        pip3 install --user scipion-installer
        python3 -m scipioninstaller -conda -noXmipp -noAsk scipion
    
    - name: Checkout repository
      uses: actions/checkout@main
      with:
        ref: ${{ github.head_ref }}

    - name: Install plugin from pull request
      working-directory: ${{ github.workspace }}
      run: ../scipion/scipion3 installp -p . --devel
