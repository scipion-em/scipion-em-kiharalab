# Name of the GitHub Action
name: Build plugin on Pull Request

# Specify when the Action should be triggered: when a pull request is opened against the 'devel' or 'master' branch
on:
  pull_request:
    branches: [devel, master]

# Define the job that should be run
jobs:
  build:
    # Specify the machine to run the job on
    runs-on: ubuntu-latest

    # Define the steps to be taken in the job
    steps:
    - name: Free Disk Space (Ubuntu only)
      uses: jlumbroso/free-disk-space@main

    # Installing scipion and miniconda dependencies
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gcc-10 g++-10 libopenmpi-dev make
        
    # Installing Miniconda
    - name: Install conda
      uses: conda-incubator/setup-miniconda@v3.0.4
      with:
        channels: conda-forge
        channel-priority: strict
        auto_update_conda: True
        python-version: ["3.9"]
    
    # Installing Scipion
    - name: Install Scipion
      working-directory: ${{ github.workspace }}/../
      run: |
        pip3 install --user scipion-installer
        python3 -m scipioninstaller -conda -noXmipp -noAsk scipion
    
    # Check out the repository in the pull request
    - name: Checkout repository
      uses: actions/checkout@main
      with:
        ref: ${{ github.head_ref }}

    # Install plugin from the pull request using the Scipion3 installp command
    - name: Install plugin from pull request
      working-directory: ${{ github.workspace }}
      run: ../scipion/scipion3 installp -p . --devel
    
    # Currently, test script is being downloaded from scipion-chem, but that should be temporary
    # Ideally, the script might be included in scipion core to be able to import it,
    # or maybe host it in a separate repository common with useful scripts for all scipion plugins
    - name: Run tests
      working-directory: ${{ github.workspace }}/${{ vars.FOLDER_WITH_VERSION }}
      run: |
        wget https://raw.githubusercontent.com/scipion-chem/scipion-chem/devel/pwchem/runTests.py
        python runTests.py ${{ github.workspace }}/../scipion/scipion3 ${{ vars.FOLDER_WITH_VERSION }} -noGPU -testData=testData.json -j=3
